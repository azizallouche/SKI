pipeline {
    agent {
        label 'agent'
    }

    stages {
        stage('Checkout from GitHub') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: 'Louay']], userRemoteConfigs: [[url: 'https://github.com/azizallouche/SKI.git']]])
            }
        }
        stage("Unit Testing") {
            steps {
                sh "mvn test"
            }
            post{
              always{
                    junit '**/target/surefire-reports/TEST-*.xml'
                }
            }
        }
       stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
        stage('SonarQube Analysis') {
            steps {
                sh 'mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=Louay1998'
            }
        }
        stage('Build Artefact'){
            steps{
                sh 'mvn clean'
                sh 'mvn package -Dmaven.test.skip=true -P test-coverage'
            }
        }
        stage('Build docker image'){
            steps{
                script{
                    sh 'docker build -t louay/devops-integration .'
                }
            }
        }
        stage('Deploy Nexus'){
            steps{
                sh 'mvn clean deploy'
            }
        }
        stage('Deploy Image to DockerHub'){
            steps{
                script{
                        sh 'sudo docker login -u louaygu -p dockerhub'
                        sh 'sudo docker tag devops-integration louaygu/devops'
                        sh 'sudo docker push louaygu/devops'
                }
            }
        }
        stage('Start Containers') {
            steps {
                sh "sudo docker-compose -f docker-compose.yaml up -d"
            }
        }
    }
    post {
        always {
            publishHTML(target: [allowMissing: false, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'target/sonar', reportFiles: 'index.html', reportName: 'SonarQube Analysis'])
        }
    }
}
